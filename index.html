<!DOCTYPE html>
<html>
<body>
<div id="cameraViewContainer" style="width: 100%; height: 60vh"></div>
<button id="drawShapes">Click to Draw Shapes</button><br /><br />
<button id="removeShapes">Click to Remove Shapes</button><br /><br />
<textarea id="results" style="width: 100%; min-height: 30vh; font-size: 3vmin; overflow: auto" disabled></textarea>
<script src="https://cdn.jsdelivr.net/npm/dynamsoft-barcode-reader@10.2.10/dist/dbr.bundle.js"></script>
<script>
  Dynamsoft.License.LicenseManager.initLicense("DLS2eyJvcmdhbml6YXRpb25JRCI6IjIwMDAwMSJ9");
  Dynamsoft.Core.CoreModule.loadWasm(["dbr"]);

  //Dictates single or multiline barcode to read
  const ROUTER_TEMPLATE = "ReadBarcodes_SpeedFirst";
  const IMAGE_CAPTURE_INTERVAL = 1000;

  let router = null;
  let view = null;
  let cameraEnhancer = null;
  let settings = null;
  let drawingLayer = null;
  let resultsContainer = null;
  let shapes = [];

  let IMEIBarcodes = {};
  let SKUBarcodes = {};

  document.getElementById("drawShapes").onclick = drawShapes;
  document.getElementById("removeShapes").onclick = removeShapes;

  (async () => {
    router = await Dynamsoft.CVR.CaptureVisionRouter.createInstance();
    view = await Dynamsoft.DCE.CameraView.createInstance();
    cameraEnhancer = await Dynamsoft.DCE.CameraEnhancer.createInstance(view);
    settings = await router.getSimplifiedSettings(ROUTER_TEMPLATE);
    settings.minImageCaptureInterval = IMAGE_CAPTURE_INTERVAL;
    await router.updateSettings(ROUTER_TEMPLATE, settings);
    drawingLayer = view.createDrawingLayer();

    document.getElementById("cameraViewContainer").append(view.getUIElement());
    router.setInput(cameraEnhancer);

    resultsContainer = document.querySelector("#results");
    router.addResultReceiver({ onDecodedBarcodesReceived: decodeBarcodes});

    await cameraEnhancer.open();
    await router.startCapturing(ROUTER_TEMPLATE);
  })();

  function drawShapes(){
    for (let imei in IMEIBarcodes) {
      const barcode = IMEIBarcodes[imei];
      const [bottomLeft, bottomRight, topRight, topLeft] = barcode.barcodeLoc;
      const {x, y} = bottomLeft;
      width = bottomRight.x - bottomLeft.x;
      height = topLeft.y - bottomLeft.y;
      const shape = new Dynamsoft.DCE.RectDrawingItem({x, y, width, height});
      shapes.push(shape);
    }
    drawingLayer.addDrawingItems(shapes);
  }

  function removeShapes() {
    drawingLayer.removeDrawingItems(shapes);
    shapes = [];
  }

  function decodeBarcodes(result) {
    if (result.barcodeResultItems.length > 0) {
        resultsContainer.textContent = '';
        for (let item of result.barcodeResultItems) {
          parseBarcode(item);
        }
        removeShapes();
        drawShapes();
    }
  }

  function isIMEI(value) {
    return !isNaN(parseInt(value.charAt(0)));
  }

  function parseBarcode(barcodeItem) {
    const barcodeText = barcodeItem.text;
    const barcodeLoc = barcodeItem.location.points;
    let barcodeType = null;
    if (isIMEI(barcodeText)) {
      barcodeType = "IMEI";
      IMEIBarcodes[barcodeText] = {barcodeText, barcodeType, barcodeLoc, shape: null}
    } else {
      barcodeType = "SKU";
    }
    return barcodeText;
  }

</script>
</body>
</html>